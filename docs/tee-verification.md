# TEE Evidence Verification

## Overview

Chutes runs workloads inside Intel TDX (Trust Domain Extensions) Confidential VMs with NVIDIA GPUs in a TEE environment where the host cannot access VM or GPU memory. Chutes verifies all servers and chute instances on its network as part of normal operations. The evidence endpoints documented here exist so that **third parties can independently verify TEE integrity without having to trust Chutes**.

A caller supplies a cryptographic nonce and receives attestation evidence proving that a specific instance is running on genuine TEE hardware. This evidence can be verified directly against Intel and NVIDIA verification infrastructure.

### How It Works

1. The caller generates a random nonce (32 bytes, hex-encoded).
2. The caller requests evidence from the Chutes API, passing the nonce.
3. Chutes retrieves a fresh TDX quote and GPU attestation evidence from the instance, bound to the caller's nonce.
4. The caller receives the evidence and verifies it independently:
   - **Intel TDX quote** -- verified via Intel's DCAP (Data Center Attestation Primitives) infrastructure, proving the workload runs in a genuine TDX enclave.
   - **NVIDIA GPU evidence** -- verified via the NVIDIA Attestation SDK, proving the GPUs are genuine NVIDIA hardware isolated from the host.
5. The nonce is embedded in both the TDX quote and GPU evidence, ensuring the attestation is fresh and not replayed.

## Key Concepts

**Nonce** -- A 64 hex character (32 byte) freshness token generated by the caller. It is embedded in the TDX quote's `report_data` field and in the GPU evidence, preventing replay attacks. Must be cryptographically random.

**TDX Quote** -- An Intel TDX attestation quote that cryptographically proves the workload runs inside a genuine TDX enclave. Contains hardware measurements (MRTD, RTMRs), a `report_data` field (which includes the caller's nonce), and a signature verifiable via Intel DCAP.

**GPU Evidence** -- Per-GPU NVIDIA attestation evidence proving the GPUs are genuine NVIDIA hardware isolated from the host. The specific isolation mechanism varies by hardware topology, but in all cases the host cannot access GPU memory. Verified via the NVIDIA Remote Attestation SDK.

**Certificate** -- The TLS certificate (base64-encoded DER) of the server hosting the instance, included in the response for reference.

**Dynamic Instances** -- Chutes scales instances up and down based on demand. New instances can appear at any time and existing instances can be removed. It is the caller's responsibility to periodically re-verify and to check any new instance IDs they encounter. See [Dynamic Instances and Caller Responsibilities](#dynamic-instances-and-caller-responsibilities) for details.

## API Reference

### Get Evidence for a Chute (All Instances)

Retrieves TEE evidence for every running instance of a chute in a single call.

```
GET /chutes/{chute_id_or_name}/evidence?nonce={nonce}
```

**Path Parameters**

| Parameter | Type | Description |
|-----------|------|-------------|
| `chute_id_or_name` | string | Chute ID (UUID) or name |

**Query Parameters**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `nonce` | string | Yes | 64 hex characters (32 bytes). Must be cryptographically random. |

**Authentication**

An API key is required unless the chute is public. For public chutes, no authentication is needed.

**Rate Limit**

60 requests per minute.

**Response**

```json
{
  "evidence": [
    {
      "quote": "<base64-encoded TDX quote>",
      "gpu_evidence": [
        { "...per-GPU attestation fields..." }
      ],
      "instance_id": "<instance-id>",
      "certificate": "<base64-encoded DER certificate>"
    }
  ],
  "failed_instance_ids": ["<instance-id>"]
}
```

| Field | Type | Description |
|-------|------|-------------|
| `evidence` | array | List of `TeeInstanceEvidence` objects, one per running instance. |
| `evidence[].quote` | string | Base64-encoded Intel TDX quote for this instance. |
| `evidence[].gpu_evidence` | array | List of per-GPU evidence dicts. Each dict contains the GPU's attestation evidence with base64-encoded fields where applicable. |
| `evidence[].instance_id` | string | The instance ID this evidence belongs to. |
| `evidence[].certificate` | string | Base64-encoded DER format TLS certificate from the server. |
| `failed_instance_ids` | array | Instance IDs where evidence retrieval failed (instances exist but the fetch encountered a transient error). |

**Error Responses**

| Status | Description |
|--------|-------------|
| 400 | Invalid nonce format (must be exactly 64 hex characters) or chute is not TEE-enabled. |
| 404 | Chute not found or you do not have access. |
| 429 | Rate limit exceeded. |
| 502 | Attestation service unavailable. The attestation proxy could not be reached. |

---

### Get Evidence for a Single Instance

Retrieves TEE evidence for one specific instance.

```
GET /instances/{instance_id}/evidence?nonce={nonce}
```

**Path Parameters**

| Parameter | Type | Description |
|-----------|------|-------------|
| `instance_id` | string | Instance ID |

**Query Parameters**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `nonce` | string | Yes | 64 hex characters (32 bytes). Must be cryptographically random. |

**Authentication**

API key required. You must own the chute, have it shared with you, or the chute must be public.

**Rate Limit**

60 requests per minute.

**Response**

```json
{
  "quote": "<base64-encoded TDX quote>",
  "gpu_evidence": [
    { "...per-GPU attestation fields..." }
  ],
  "instance_id": "<instance-id>",
  "certificate": "<base64-encoded DER certificate>"
}
```

| Field | Type | Description |
|-------|------|-------------|
| `quote` | string | Base64-encoded Intel TDX quote. |
| `gpu_evidence` | array | List of per-GPU evidence dicts with base64-encoded fields where applicable. |
| `instance_id` | string | The instance ID. |
| `certificate` | string | Base64-encoded DER format TLS certificate from the server. |

**Error Responses**

| Status | Description |
|--------|-------------|
| 400 | Invalid nonce format, chute is not TEE-enabled, or instance requires `chutes_version >= 0.6.0`. |
| 404 | Instance not found. |
| 403 | You do not have access to this instance. |
| 429 | Rate limit exceeded. |
| 502 | Attestation service unavailable. The attestation proxy could not be reached. |

## Verification Guide

This section walks through how to independently verify the evidence returned by these endpoints.

### Step 1: Generate a Nonce

Generate a cryptographically random 32-byte nonce, hex-encoded to 64 characters:

```python
import secrets

nonce = secrets.token_hex(32)  # 64 hex characters
```

Or from the command line:

```bash
openssl rand -hex 32
```

### Step 2: Request Evidence

**Using curl** (chute evidence for all instances):

```bash
NONCE=$(openssl rand -hex 32)

curl "https://api.chutes.ai/chutes/{chute_id_or_name}/evidence?nonce=$NONCE" \
  -H "Authorization: Bearer $CHUTES_API_KEY"
```

**Using curl** (single instance):

```bash
curl "https://api.chutes.ai/instances/{instance_id}/evidence?nonce=$NONCE" \
  -H "Authorization: Bearer $CHUTES_API_KEY"
```

**Using Python:**

```python
import secrets
import requests

API_KEY = "your-api-key"
CHUTE_ID = "your-chute-id"
nonce = secrets.token_hex(32)

response = requests.get(
    f"https://api.chutes.ai/chutes/{CHUTE_ID}/evidence",
    params={"nonce": nonce},
    headers={"Authorization": f"Bearer {API_KEY}"},
)
response.raise_for_status()
data = response.json()
```

### Step 3: Verify the Intel TDX Quote

The TDX quote proves the workload is running inside a genuine Intel TDX enclave. Verification uses the `dcap-qvl` Python library, which validates the quote's cryptographic signature against Intel's DCAP collateral (certificate chain, TCB info, etc.).

```python
import base64
import json
from dcap_qvl import get_collateral_and_verify

quote_b64 = data["evidence"][0]["quote"]  # or data["quote"] for single instance
quote_bytes = base64.b64decode(quote_b64)

# Verify the quote signature against Intel's DCAP collateral.
# This contacts Intel's Provisioning Certification Service to fetch
# the collateral needed for verification.
verified_report = await get_collateral_and_verify(quote_bytes)
report = json.loads(verified_report.to_json())
```

After verification, check the following:

**1. Signature status must be `UpToDate`:**

```python
status = report.get("status", "Unknown")
assert status == "UpToDate", f"Quote verification status: {status}"
```

**2. Debug mode must be disabled:**

The TD must not be running in debug mode. Debug mode is indicated by bit 0 of `td_attributes`:

```python
td_report = report.get("report", {}).get("TD10", {})
td_attributes = td_report.get("td_attributes", "")
attr_value = int(td_attributes, 16)
debug_enabled = bool(attr_value & 1)
assert not debug_enabled, "TD is running in debug mode"
```

**3. Nonce must match what you sent:**

The nonce you provided is embedded in the first 64 hex characters of the quote's `report_data` field. You can extract it by parsing the raw quote bytes:

```python
# The TD report starts at byte offset 48 in the quote.
# report_data is at offset 520-584 within the TD report (offset 568-632 in the full quote).
td_report_bytes = quote_bytes[48:632]
report_data_hex = td_report_bytes[520:584].hex()

# First 64 hex chars of report_data = nonce
extracted_nonce = report_data_hex[:64]
assert extracted_nonce.lower() == nonce.lower(), "Nonce mismatch -- possible replay"
```

### Step 4: Verify NVIDIA GPU Evidence

The GPU evidence proves the instance is using genuine NVIDIA GPUs that are isolated from the host. Verification uses the `nv-attestation-sdk` package, which validates the evidence against NVIDIA's Remote Attestation Service.

```python
from nv_attestation_sdk.attestation import Attestation, Devices, Environment

gpu_evidence = data["evidence"][0]["gpu_evidence"]  # or data["gpu_evidence"] for single instance

client = Attestation()
client.add_verifier(Devices.GPU, Environment.REMOTE, "", "")
client.set_nonce(nonce)
result = client.attest(gpu_evidence)
assert result, "GPU attestation failed"
```

This verifies that:
- The GPUs are genuine NVIDIA hardware, isolated from the host.
- The evidence is bound to the nonce you provided, ensuring freshness.

## Complete Example

A full end-to-end script that requests evidence for a chute and verifies both the TDX quote and GPU attestation:

```python
import asyncio
import base64
import json
import secrets

import requests
from dcap_qvl import get_collateral_and_verify
from nv_attestation_sdk.attestation import Attestation, Devices, Environment

API_BASE = "https://api.chutes.ai"
API_KEY = "your-api-key"
CHUTE_ID = "your-chute-id"


def verify_tdx_quote(quote_b64: str, expected_nonce: str) -> dict:
    """Verify a TDX quote and return the parsed report."""
    quote_bytes = base64.b64decode(quote_b64)

    # Verify signature against Intel DCAP collateral
    verified_report = asyncio.get_event_loop().run_until_complete(
        get_collateral_and_verify(quote_bytes)
    )
    report = json.loads(verified_report.to_json())

    # Check signature status
    status = report.get("status", "Unknown")
    if status != "UpToDate":
        raise ValueError(f"TDX quote verification status: {status}")

    # Check debug mode is disabled
    td_report = report.get("report", {}).get("TD10", {})
    td_attributes = td_report.get("td_attributes", "")
    if td_attributes:
        attr_value = int(td_attributes, 16)
        if attr_value & 1:
            raise ValueError("TD is running in debug mode")

    # Extract and verify nonce from report_data
    td_report_bytes = quote_bytes[48:632]
    report_data_hex = td_report_bytes[520:584].hex()
    extracted_nonce = report_data_hex[:64]
    if extracted_nonce.lower() != expected_nonce.lower():
        raise ValueError(
            f"Nonce mismatch: expected {expected_nonce}, got {extracted_nonce}"
        )

    return report


def verify_gpu_evidence(gpu_evidence: list, nonce: str) -> bool:
    """Verify NVIDIA GPU attestation evidence."""
    client = Attestation()
    client.add_verifier(Devices.GPU, Environment.REMOTE, "", "")
    client.set_nonce(nonce)
    return client.attest(gpu_evidence)


def main():
    # 1. Generate a fresh nonce
    nonce = secrets.token_hex(32)
    print(f"Generated nonce: {nonce}")

    # 2. Request evidence
    response = requests.get(
        f"{API_BASE}/chutes/{CHUTE_ID}/evidence",
        params={"nonce": nonce},
        headers={"Authorization": f"Bearer {API_KEY}"},
    )
    response.raise_for_status()
    chute_evidence = response.json()

    print(f"Received evidence for {len(chute_evidence['evidence'])} instance(s)")
    if chute_evidence["failed_instance_ids"]:
        print(
            f"Warning: evidence retrieval failed for instances: "
            f"{chute_evidence['failed_instance_ids']}"
        )

    # 3. Verify each instance
    for instance_evidence in chute_evidence["evidence"]:
        instance_id = instance_evidence["instance_id"]
        print(f"\nVerifying instance: {instance_id}")

        # Verify TDX quote
        try:
            report = verify_tdx_quote(instance_evidence["quote"], nonce)
            print(f"  TDX quote: PASSED (status={report['status']})")
        except Exception as e:
            print(f"  TDX quote: FAILED ({e})")
            continue

        # Verify GPU evidence
        try:
            gpu_ok = verify_gpu_evidence(instance_evidence["gpu_evidence"], nonce)
            print(f"  GPU attestation: {'PASSED' if gpu_ok else 'FAILED'}")
        except Exception as e:
            print(f"  GPU attestation: FAILED ({e})")


if __name__ == "__main__":
    main()
```

## Dynamic Instances and Caller Responsibilities

Chutes instances are ephemeral -- they scale up and down based on demand. This has important implications for verification:

- **The chute evidence endpoint returns evidence for all currently-running instances.** The set of instances can change between calls.
- **New instances may appear at any time.** An instance that was not present in a previous evidence response may appear in the next one.
- **Previously-verified instances may disappear.** An instance you verified earlier may have been scaled down and no longer exists.
- **Callers should re-verify periodically.** Generate a fresh nonce and request new evidence on a schedule appropriate for your trust requirements.
- **Verify any new instance IDs.** When the evidence response contains an `instance_id` you haven't seen before, verify its evidence before trusting it.
- **Handle `failed_instance_ids` appropriately.** This field lists instances that exist but whose evidence could not be fetched due to a transient error (e.g., the attestation proxy was temporarily unreachable). These instances are still running but could not be verified in this request. Consider retrying or treating them as unverified depending on your requirements.

## What You're Verifying

| Check | What It Proves |
|-------|---------------|
| Intel TDX quote signature (DCAP) | The workload is running inside a genuine Intel TDX enclave on real hardware. |
| Nonce in `report_data` | The attestation is fresh and was generated in response to your specific request (not replayed). |
| Debug mode disabled | The TD is running in production mode, not a debug configuration that would weaken isolation. |
| NVIDIA GPU attestation | The GPUs are genuine NVIDIA hardware, isolated from the host (the host cannot access GPU memory). |

## Dependencies

The following Python packages are needed for independent verification:

| Package | Purpose |
|---------|---------|
| `dcap-qvl` | Intel TDX DCAP quote verification. Validates quote signatures against Intel's Provisioning Certification Service. |
| `nv-attestation-sdk` | NVIDIA Remote GPU Attestation. Validates GPU evidence against NVIDIA's attestation service. |
| `cryptography` | X.509 certificate parsing (if inspecting the returned certificate). |

Install them with:

```bash
pip install dcap-qvl nv-attestation-sdk cryptography
```
